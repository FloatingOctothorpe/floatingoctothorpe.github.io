<!DOCTYPE html>
<html lang="en-GB">
<head>
  <title>Floating Octothorpe: Decrypting HTTPS traffic without a key</title>

  <meta charset="utf-8" />
  <meta name="Author" content="Floating Octothorpe" />
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="icon" type="image/png" href="/img/favicon.png" />
</head>
<body>
  <header>
    <a href="/"><img class="logo" src="/img/logo.png" alt="Floating Octothorpe logo"/></a>
    <h1 class="site-title">Floating Octothorpe</h1>
    <nav>
      <ul>
        <li><a href="/">Latest</a></li>
        <li><a href="/archive.html">Archive</a></li>
        <li><a href="/about.html">About</a></li>
      </ul>
    </nav>
  </header>
  <article>
<h1>Decrypting HTTPS traffic without a key</h1>

<time datetime="2017-04-07">07 April 2017</time>

<p><a href="/2017/decrypting-https-traffic-with-wireshark.html">Last week's post</a> went over decrypting HTTPS traffic using an
RSA private key. There are two main downsides to this method:</p>
<ul>
<li>It can only be used if you have access to the server-side private key.</li>
<li>If a key exchange method like <a href="https://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange">Diffie-Hellman</a> is used
   to create an ephemeral key, the RSA key cannot be used to decrypt the
   traffic.</li>
</ul>
<p>It is however possible to capture and decrypt HTTPS traffic without access to
the web server.</p>
<h2>Capturing traffic</h2>
<p>First make sure <code>tcpdump</code> and <code>curl</code> are installed. This can be done on CentOS
with the following command:</p>
<pre><code>yum install -y tcpdump curl
</code></pre>
<p>Once the required packages are installed, a <a href="http://man7.org/linux/man-pages/man1/tcpdump.1.html">tcpdump</a> command
similar to the following can be run on the client to capture packets sent
to/from the web server (<code>10.0.2.10</code>):</p>
<pre><code>tcpdump -w /tmp/https.pcap -B 40960 host 10.0.2.10
</code></pre>
<p>Once <code>tcpdump</code> is listening, the following <code>curl</code> command can be run to make
the HTTP request:</p>
<pre><code>SSLKEYLOGFILE=ssl_log.txt curl --insecure --ciphers dhe_rsa_aes_128_cbc_sha_256 https://10.0.2.11/message.txt
</code></pre>
<p>This will create a log file called <code>ssl_log.txt</code> which will contain the
ephemeral key generated during the key exchange. The contents of the file will
look something like this:</p>
<pre><code># SSL/TLS secrets log file, generated by NSS
CLIENT_RANDOM 1b3f3d069a30941f67296a95d5f0e593b5ba3fe323e742e58d16e7ddefb3b833 454b10d4c95d877f1a21ac2f67f4ef87a48aede256b2fcf655f5f7607edc6c54fcfaacea72379abeaaaae30f9cbc81c4
</code></pre>
<p>Finally end the packet capture by pressing <kbd>ctrl</kbd> + <kbd>c</kbd> to
kill <code>tcpdump</code>.</p>
<p><strong>Note</strong>: the <code>SSLKEYLOGFILE</code> environment variable can also be used with other
software that uses NSS libraries, for example Firefox.</p>
<h2>Decrypting traffic</h2>
<p>To decrypt the packet capture, carry out the following steps:</p>
<ol>
<li>Open the packet capture in Wireshark</li>
<li>Open <code>Edit -&gt; Preferences</code></li>
<li>Find <code>SSL</code> under the <code>protocol</code> section</li>
<li>Set the <code>(Pre) - Master - Secret log filename</code> to match the path used with
    the <code>SSLKEYLOGFILE</code> environment variable</li>
</ol>
<p>After running through the steps above you should hopefully see the decrypted
HTTP request.</p>
<h3>Protocol support</h3>
<p>The example above forces curl to use <code>TLS_DHE_RSA_WITH_AES_128_CBC_SHA256</code>.
This can be decrypted with the version of Wireshark (<code>wireshark-1.10.14</code>)
distributed with CentOS 7.</p>
<p>Unfortunately some ciphers (e.g. <code>TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384</code>)
require a later version of Wireshark. To get around this on CentOS Wireshark
can be compiled from source with the following commands:</p>
<pre><code># Install build dependencies (as root)
yum install -y \
  libgcrypt-devel openssl-devel nss-devel gnutls-devel qt5-linguist gcc \
  gcc-c++ bison flex libpcap-devel qt-devel gtk3-devel rpm-build libtool \
  c-ares-devel qt5-qtbase-devel qt5-qtmultimedia-devel desktop-file-utils

# Extract the source code
tar xf wireshark-2.2.5.tar.bz2
cd wireshark-2.2.5

# Configure with packages needed for decrypting tls
./configure --with-gnutls --with-ssl --with-gcrypt

# Finally compile everything
make
</code></pre>
<p><strong>Note</strong>: the source code for Wireshark is available from
<a href="https://www.wireshark.org/download.html">wireshark.org</a>.</p>
  </article>
  <footer class="footer pure-u-1 pure-u-md-3-4">
    <hr />
    <small>
      Copyright &copy; 2020 Floating Octothorpe. Except where
      otherwise noted, content on this site is licensed under a
      <a rel="license"
         href="https://creativecommons.org/licenses/by/4.0/">Creative Commons
          Attribution 4.0 License</a>.
    </small>
  </footer>
</body>
</html>